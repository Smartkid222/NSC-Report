<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>School Result Management System</title>
    <style>
      /* --- CORE VARIABLES & RESET --- */
      :root {
        --primary: #2563eb;
        --primary-dark: #1e40af;
        --secondary: #64748b;
        --bg: #f1f5f9;
        --surface: #ffffff;
        --text: #0f172a;
        --border: #e2e8f0;
        --success: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
        --shadow:
          0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        --radius: 8px;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        outline: none;
      }
      body {
        font-family: "Segoe UI", Roboto, sans-serif;
        background-color: var(--bg);
        color: var(--text);
        line-height: 1.6;
        min-height: 100vh;
      }

      /* --- UTILITIES --- */
      .hidden {
        display: none !important;
      }
      .flex {
        display: flex;
      }
      .flex-col {
        flex-direction: column;
      }
      .items-center {
        align-items: center;
      }
      .justify-between {
        justify-content: space-between;
      }
      .gap-2 {
        gap: 0.5rem;
      }
      .gap-4 {
        gap: 1rem;
      }
      .text-sm {
        font-size: 0.875rem;
      }
      .font-bold {
        font-weight: 700;
      }
      .w-full {
        width: 100%;
      }
      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      /* --- BUTTONS --- */
      .btn {
        padding: 0.6rem 1.2rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
        font-size: 0.9rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
      }
      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .btn-primary {
        background-color: var(--primary);
        color: white;
      }
      .btn-primary:hover {
        background-color: var(--primary-dark);
      }
      .btn-outline {
        background-color: transparent;
        border: 1px solid var(--primary);
        color: var(--primary);
      }
      .btn-outline:hover {
        background-color: #eff6ff;
      }
      .btn-danger {
        background-color: var(--danger);
        color: white;
      }
      .btn-sm {
        padding: 0.4rem 0.8rem;
        font-size: 0.85rem;
      }
      .btn-filter {
        font-size: 0.85rem;
        padding: 0.4rem 1rem;
        border-radius: 20px;
        background: #e2e8f0;
        color: var(--secondary);
        border: none;
        cursor: pointer;
      }
      .btn-filter.active {
        background: var(--primary);
        color: white;
      }

      /* --- LOADING OVERLAY --- */
      .loader-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(4px);
        display: none; /* Hidden by default */
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
      .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid var(--border);
        border-top: 5px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* --- AUTH VIEW STYLES --- */
      .auth-wrapper {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }
      .auth-container {
        background: white;
        width: 100%;
        max-width: 600px;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        overflow: hidden;
        animation: slideUp 0.4s ease;
      }
      @keyframes slideUp {
        from {
          transform: translateY(20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .auth-header {
        text-align: center;
        padding: 0;
        border-bottom: 1px solid #eee;
      }
      .app-title {
        padding: 20px 0 10px;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text);
      }
      .tabs {
        display: flex;
      }
      .tab-btn {
        flex: 1;
        padding: 15px;
        border: none;
        background: #f8f9fa;
        cursor: pointer;
        color: #777;
        transition: 0.3s;
        border-bottom: 2px solid transparent;
      }
      .tab-btn.active {
        background: white;
        color: var(--primary);
        border-bottom: 2px solid var(--primary);
      }
      .forms-wrapper {
        padding: 30px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        margin-bottom: 6px;
        font-size: 0.9rem;
        color: #555;
        font-weight: 500;
      }
      .form-control {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: var(--radius);
        font-size: 1rem;
        transition: border 0.3s;
      }
      .form-control:focus {
        border-color: var(--primary);
      }

      .name-row {
        display: flex;
        gap: 10px;
      }
      .name-row .form-group {
        flex: 1;
      }
      .subject-builder {
        background: #f8fafc;
        padding: 15px;
        border-radius: var(--radius);
        border: 1px dashed #cbd5e1;
        margin-bottom: 15px;
      }
      .chip-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
      }
      .subject-chip {
        background: #e0f2fe;
        color: #0369a1;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .chip-remove {
        cursor: pointer;
        font-weight: bold;
        color: #dc2626;
      }
      .chip-remove:hover {
        color: #b91c1c;
      }

      /* --- DASHBOARD VIEW STYLES --- */
      header {
        background: var(--surface);
        padding: 1rem 2rem;
        box-shadow: var(--shadow);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .logo {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--primary);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      /* Cards & Grid */
      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
      }
      .card {
        background: var(--surface);
        border-radius: 12px;
        padding: 20px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
        transition: transform 0.2s;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
      }
      .card:hover {
        transform: translateY(-4px);
        border-color: var(--primary);
      }
      .card-lg {
        grid-column: 1 / -1;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 30px;
        border-left: 5px solid var(--primary);
        background: linear-gradient(to right, #fff, #f8fafc);
      }

      .badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
      }
      .badge-jss {
        background: #e0f2fe;
        color: #0369a1;
      }
      .badge-sss {
        background: #fef3c7;
        color: #b45309;
      }

      /* Tables */
      .table-container {
        overflow-x: auto;
        background: var(--surface);
        border-radius: 8px;
        box-shadow: var(--shadow);
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid var(--border);
      }
      th {
        background: #f8fafc;
        font-weight: 600;
        color: var(--secondary);
        font-size: 0.9rem;
        white-space: nowrap;
      }
      tr:hover {
        background: #f1f5f9;
      }

      .score-input-mini {
        width: 60px;
        padding: 6px;
        border: 1px solid #ddd;
        border-radius: 4px;
        text-align: center;
      }
      .score-input-mini:focus {
        border-color: var(--primary);
        outline: none;
      }
      .total-mini {
        font-weight: bold;
        display: inline-block;
        width: 40px;
        text-align: center;
      }

      /* Student Detail View */
      .score-card {
        background: var(--surface);
        padding: 25px;
        border-radius: 12px;
        box-shadow: var(--shadow);
      }
      .score-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 25px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--border);
      }
      .avatar {
        width: 60px;
        height: 60px;
        background: var(--primary);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: bold;
      }

      .score-row {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 80px;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #f1f5f9;
      }
      .score-input {
        width: 100%;
        padding: 8px;
        border: 1px solid var(--border);
        border-radius: 4px;
        text-align: center;
      }
      .score-input:disabled {
        background: #f8fafc;
        color: #94a3b8;
        cursor: not-allowed;
        border-color: transparent;
      }
      .subject-label {
        font-weight: 500;
        display: flex;
        flex-direction: column;
      }
      .readonly-badge {
        font-size: 0.7rem;
        color: var(--secondary);
        font-weight: normal;
        font-style: italic;
      }

      /* Modals & Toasts */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .modal {
        background: white;
        width: 90%;
        max-width: 500px;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        animation: slideUp 0.3s ease;
        max-height: 90vh;
        overflow-y: auto;
      }

      .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        transform: translateY(100px);
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        z-index: 2000;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .toast.show {
        transform: translateY(0);
      }
      .toast.success {
        background-color: var(--success);
      }
      .toast.error {
        background-color: var(--danger);
      }

      .breadcrumbs {
        font-size: 0.9rem;
        color: var(--secondary);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }
      .breadcrumbs span {
        cursor: pointer;
      }
      .breadcrumbs span:hover {
        color: var(--primary);
        text-decoration: underline;
      }
      .breadcrumbs span:last-child {
        cursor: default;
        color: var(--text);
        font-weight: 600;
        text-decoration: none;
      }

      /* Print Styles */
      #printable-area {
        display: none;
      }
      @media print {
        body * {
          visibility: hidden;
        }
        #printable-area,
        #printable-area * {
          visibility: visible;
        }
        #printable-area {
          display: block;
          position: absolute;
          left: 0;
          top: 0;
          width: 100%;
          background: white;
          padding: 20px;
          font-family: "Times New Roman", serif;
        }
        .rp-header {
          text-align: center;
          border-bottom: 3px double #000;
          padding-bottom: 10px;
          margin-bottom: 20px;
        }
        .rp-table {
          width: 100%;
          border-collapse: collapse;
          margin-bottom: 20px;
        }
        .rp-table th,
        .rp-table td {
          border: 1px solid #000;
          padding: 8px;
          text-align: center;
        }
      }

      /* ================= MOBILE RESPONSIVENESS IMPROVEMENTS ================= */
      @media (max-width: 600px) {
        /* --- 1. AUTH FORM FIXES --- */
        /* Stack name fields vertically on mobile */
        .name-row {
          flex-direction: column;
          gap: 0;
        }

        /* Ensure the auth container takes full width */
        .auth-container {
          width: 100%;
          border-radius: 0;
          box-shadow: none;
        }

        .forms-wrapper {
          padding: 20px;
        }

        /* --- 2. SCORE ENTRY TABLE CARD LAYOUT (The Fix You Requested) --- */

        /* Target the specific section where score entry happens */
        #section-batch-entry table,
        #section-batch-entry thead,
        #section-batch-entry tbody,
        #section-batch-entry th,
        #section-batch-entry td,
        #section-batch-entry tr {
          display: block; /* Converts table elements to block elements */
        }

        /* Hide the original horizontal header to save space */
        #section-batch-entry thead tr {
          position: absolute;
          top: -9999px;
          left: -9999px;
        }

        /* Style each Row as a Card */
        #section-batch-entry tr {
          background: #fff;
          border: 1px solid var(--border);
          border-radius: 12px;
          margin-bottom: 20px; /* Space between cards */
          padding: 15px;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
          animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
          from {
            opacity: 0;
            transform: translateY(10px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        /* Style individual cells within the card */
        #section-batch-entry td {
          position: relative;
          padding: 0;
          text-align: left;
          display: flex; /* Use flex for alignment */
          flex-direction: column; /* Stack label and content */
          margin-bottom: 15px;
          border: none;
        }

        #section-batch-entry td:last-child {
          margin-bottom: 0;
        }

        /* --- AUTOMATIC LABELS VIA CSS --- */
        /* Since we hid the <thead>, we add labels here */
        #section-batch-entry td:nth-of-type(1)::before {
          content: "Admin No";
          font-weight: 600;
          color: var(--secondary);
          font-size: 0.8rem;
          margin-bottom: 4px;
          display: block;
        }
        #section-batch-entry td:nth-of-type(2)::before {
          content: "Student Name";
          font-weight: 600;
          color: var(--secondary);
          font-size: 0.8rem;
          margin-bottom: 4px;
          display: block;
        }
        #section-batch-entry td:nth-of-type(3)::before {
          content: "CA Score (40)";
          font-weight: 600;
          color: var(--secondary);
          font-size: 0.9rem;
          margin-bottom: 8px;
          display: block;
        }
        #section-batch-entry td:nth-of-type(4)::before {
          content: "Exam Score (60)";
          font-weight: 600;
          color: var(--secondary);
          font-size: 0.9rem;
          margin-bottom: 8px;
          display: block;
        }
        #section-batch-entry td:nth-of-type(5)::before {
          content: "Total Score";
          font-weight: 600;
          color: var(--primary);
          font-size: 0.9rem;
          margin-bottom: 5px;
          display: block;
        }

        /* --- SPECIFIC STYLING FOR CONTENT --- */

        /* 1. Admin No & Name Styling */
        #section-batch-entry td:nth-of-type(1),
        #section-batch-entry td:nth-of-type(2) {
          border-bottom: 1px solid #f1f5f9;
          padding-bottom: 10px;
          margin-bottom: 15px;
        }
        #section-batch-entry td:nth-of-type(1) {
          color: var(--primary);
          font-weight: bold;
          font-size: 1.1rem;
        }
        #section-batch-entry td:nth-of-type(2) {
          font-size: 1.2rem;
          font-weight: 700;
          color: var(--text);
        }

        /* 2. Inputs (CA & Exam) */
        #section-batch-entry input {
          width: 100%;
          padding: 12px;
          font-size: 1.1rem;
          border: 2px solid #ddd;
          border-radius: 8px;
          text-align: center;
          transition: border-color 0.2s;
        }
        #section-batch-entry input:focus {
          border-color: var(--primary);
          background-color: #f8fafc;
        }

        /* 3. Total Score */
        #section-batch-entry .total-mini {
          width: 100%;
          font-size: 1.5rem;
          color: var(--primary);
          text-align: right;
          display: block;
          background: #eff6ff;
          padding: 10px;
          border-radius: 6px;
        }

        /* --- BUTTON ADJUSTMENTS --- */
        #section-batch-entry .btn {
          width: 100%;
          justify-content: center;
          margin-top: 10px;
        }
      }
    </style>
  </head>
  <body>
    <!-- GLOBAL LOADING SPINNER -->
    <div id="loader" class="loader-overlay">
      <div class="spinner"></div>
      <p style="margin-top: 15px; font-weight: 600; color: var(--primary)">
        Processing...
      </p>
    </div>

    <!-- ================= AUTH VIEW ================= -->
    <div id="view-auth" class="auth-wrapper">
      <div class="auth-container">
        <div class="auth-header">
          <h1 class="app-title">Teacher Portal</h1>
          <div class="tabs">
            <button class="tab-btn active" onclick="app.switchAuthTab('login')">
              Login
            </button>
            <button class="tab-btn" onclick="app.switchAuthTab('signup')">
              Sign Up
            </button>
          </div>
        </div>

        <div class="forms-wrapper">
          <!-- LOGIN FORM -->
          <form id="form-login" onsubmit="app.handleLogin(event)">
            <div class="name-row">
              <div class="form-group">
                <label>Title</label>
                <select id="loginTitle" class="form-control">
                  <option value="Mr.">Mr.</option>
                  <option value="Mrs.">Mrs.</option>
                  <option value="Miss">Miss</option>
                  <option value="Dr.">Dr.</option>
                </select>
              </div>
              <div class="form-group">
                <label>First Name</label>
                <input
                  type="text"
                  id="loginFirstName"
                  class="form-control"
                  placeholder="First"
                  required
                />
              </div>
              <div class="form-group">
                <label>Last Name</label>
                <input
                  type="text"
                  id="loginLastName"
                  class="form-control"
                  placeholder="Last"
                  required
                />
              </div>
            </div>
            <div class="form-group">
              <label>Password</label>
              <input
                type="password"
                id="loginPass"
                class="form-control"
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                required
              />
            </div>
            <button type="submit" class="btn btn-primary w-full">
              Login to Dashboard
            </button>
          </form>

          <!-- SIGNUP FORM -->
          <form
            id="form-signup"
            class="hidden"
            onsubmit="app.handleSignup(event)"
          >
            <div class="form-group">
              <label>Role</label>
              <select
                id="signupRole"
                class="form-control"
                onchange="app.handleRoleChange()"
                required
              >
                <option value="Teacher">Teacher</option>
                <option value="Class Teacher">Class Teacher</option>
                <option value="Admin">Admin</option>
                <option value="Head">Head</option>
              </select>
            </div>
            <div class="name-row">
              <div class="form-group">
                <label>Title</label>
                <select id="signupTitle" class="form-control">
                  <option value="Mr.">Mr.</option>
                  <option value="Mrs.">Mrs.</option>
                  <option value="Miss">Miss</option>
                  <option value="Dr.">Dr.</option>
                </select>
              </div>
              <div class="form-group">
                <label>First Name</label>
                <input
                  type="text"
                  id="signupFirstName"
                  class="form-control"
                  placeholder="First"
                  required
                />
              </div>
              <div class="form-group">
                <label>Last Name</label>
                <input
                  type="text"
                  id="signupLastName"
                  class="form-control"
                  placeholder="Last"
                  required
                />
              </div>
            </div>
            <div class="form-group">
              <label>Password</label>
              <input
                type="password"
                id="signupPass"
                class="form-control"
                required
              />
            </div>

            <div id="class-teacher-group" class="hidden form-group">
              <label>Assigned Class (As Class Teacher)</label>
              <select id="signupClass" class="form-control">
                <option value="" disabled selected>Select Class</option>
                <option value="JSS1">JSS1</option>
                <option value="JSS2">JSS2</option>
                <option value="JSS3">JSS3</option>
                <option value="SSS1">SSS1</option>
                <option value="SSS2">SSS2</option>
                <option value="SSS3">SSS3</option>
              </select>
            </div>

            <div id="subject-group">
              <div class="subject-builder">
                <label style="margin-bottom: 8px; display: block"
                  >Subjects Taught</label
                >
                <div class="flex gap-2">
                  <select
                    id="subjectLevel"
                    class="form-control"
                    onchange="app.populateSubjects()"
                  >
                    <option value="" disabled selected>Level</option>
                    <option value="JSS">JSS</option>
                    <option value="SSS">SSS</option>
                  </select>
                  <select id="subjectName" class="form-control">
                    <option value="" disabled selected>Subject</option>
                  </select>
                  <select id="subjectClass" class="form-control">
                    <option value="" disabled selected>Class</option>
                  </select>
                  <button
                    type="button"
                    class="btn btn-primary"
                    onclick="app.addSubject()"
                  >
                    +
                  </button>
                </div>
                <div id="chipList" class="chip-list"></div>
                <small
                  id="subjectError"
                  style="color: var(--danger); display: none"
                  >Add at least one subject</small
                >
              </div>
            </div>

            <button type="submit" class="btn btn-primary w-full">
              Create Account
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- ================= DASHBOARD VIEW ================= -->
    <div id="view-dashboard" class="hidden">
      <header>
        <div class="logo">
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M22 10v6M2 10l10-5 10 5-10 5z" />
            <path d="M6 12v5c3 3 9 3 12 0v-5" />
          </svg>
          NSCR-Manager
        </div>
        <div class="flex items-center gap-4">
          <div class="text-right">
            <div id="user-display-name" class="font-bold">Teacher Name</div>
            <div id="user-display-role" class="text-sm text-secondary">
              Role
            </div>
          </div>
          <button class="btn btn-outline btn-sm" onclick="app.logout()">
            Logout
          </button>
        </div>
      </header>

      <main class="container">
        <!-- 1. DASHBOARD LANDING -->
        <section id="section-landing">
          <!-- Injected via JS -->
        </section>

        <!-- 2. CLASS LIST (For Subject Teachers / Admin Manage Students) -->
        <section id="section-class-list" class="hidden">
          <div class="breadcrumbs">
            <span onclick="app.goHome()">Home</span> >
            <span id="breadcrumb-action">Classes</span>
          </div>
          <h2 id="list-title" style="margin-bottom: 15px">Classes</h2>
          <div class="dashboard-grid" id="class-grid"></div>
        </section>

        <!-- 3. SUBJECT LIST (Select Subject within a Class) -->
        <section id="section-subject-list" class="hidden">
          <div class="breadcrumbs">
            <span onclick="app.goHome()">Home</span> >
            <span id="crumb-cls-action">Classes</span> >
            <span id="crumb-class-name"></span>
          </div>

          <!-- DEPARTMENT FILTER (SSS Only) -->
          <div
            id="dept-filter-container"
            class="hidden"
            style="margin-bottom: 20px; text-align: center"
          >
            <button
              class="btn-filter active"
              onclick="app.filterSSSSubjects('All', this)"
            >
              All
            </button>
            <button
              class="btn-filter"
              onclick="app.filterSSSSubjects('Science', this)"
            >
              Sci
            </button>
            <button
              class="btn-filter"
              onclick="app.filterSSSSubjects('Art', this)"
            >
              Art
            </button>
            <button
              class="btn-filter"
              onclick="app.filterSSSSubjects('Commercial', this)"
            >
              Comm
            </button>
          </div>

          <h2 style="margin-bottom: 15px">Select Subject</h2>
          <div class="dashboard-grid" id="subject-grid"></div>
        </section>

        <!-- 4. BATCH SCORE ENTRY (Subject-based: Class -> Subject -> Students) -->
        <section id="section-batch-entry" class="hidden">
          <div class="breadcrumbs">
            <span onclick="app.goHome()">Home</span> >
            <span id="batch-crumb-class"></span> >
            <span id="batch-crumb-subject"></span>
          </div>
          <div
            class="flex justify-between items-center"
            style="margin-bottom: 20px"
          >
            <h2>Student Scores</h2>
            <div id="batch-actions">
              <!-- Add Student button for Admin -->
            </div>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <!-- Headers injected by JS -->
                <tr id="batch-headers"></tr>
              </thead>
              <tbody id="batch-rows"></tbody>
            </table>
          </div>
          <div style="margin-top: 20px; text-align: right">
            <button class="btn btn-primary" onclick="app.saveBatchScores()">
              Save All Scores
            </button>
          </div>
        </section>

        <!-- 5. STUDENT LIST (For Class Teachers / Admin Check Scores) -->
        <section id="section-student-list" class="hidden">
          <div class="breadcrumbs">
            <span onclick="app.goHome()">Home</span> >
            <span id="std-list-crumb-cls"></span>
          </div>
          <div
            class="flex justify-between items-center"
            style="margin-bottom: 20px"
          >
            <h2>Students</h2>
            <input
              type="text"
              id="std-search"
              class="form-control"
              placeholder="Search..."
              style="width: 200px"
              onkeyup="app.filterStudentList()"
            />
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Admin No</th>
                  <th>Name</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="std-list-rows"></tbody>
            </table>
          </div>
        </section>

        <!-- 6. STUDENT DETAIL (All subjects for one student) -->
        <section id="section-student-detail" class="hidden">
          <div class="breadcrumbs">
            <span onclick="app.goHome()">Home</span> >
            <span id="det-crumb-cls"></span> > <span id="det-crumb-name"></span>
          </div>
          <div class="score-card">
            <div class="score-header">
              <div class="avatar" id="det-avatar">?</div>
              <div>
                <h2 id="det-name">Student Name</h2>
                <p class="text-secondary" id="det-info">Class Info</p>
              </div>
            </div>
            <form
              onsubmit="
                event.preventDefault();
                app.saveStudentDetail();
              "
            >
              <div id="det-score-rows"></div>
              <div
                class="flex justify-between"
                style="
                  margin-top: 20px;
                  border-top: 1px solid #eee;
                  padding-top: 20px;
                "
              >
                <button
                  type="button"
                  class="btn btn-outline"
                  onclick="app.closeStudentDetail()"
                >
                  Back
                </button>
                <div class="flex gap-2">
                  <button
                    type="button"
                    class="btn btn-outline"
                    onclick="app.openPrintModal()"
                  >
                    Print
                  </button>
                  <button
                    onclick="app.saveStudentScores()"
                    class="btn btn-primary"
                  >
                    Save Changes
                  </button>
                </div>
              </div>
            </form>
          </div>
        </section>
      </main>
    </div>

    <!-- ================= MODALS ================= -->
    <div id="modal-add-student" class="modal-overlay">
      <div class="modal">
        <h3>Add New Student</h3>
        <div class="form-group">
          <label>Full Name</label
          ><input type="text" id="newStdName" class="form-control" />
        </div>
        <div class="form-group">
          <label>Admin ID</label
          ><input type="text" id="newStdId" class="form-control" />
        </div>
        <div class="form-group">
          <label>Gender</label
          ><select id="newStdGender" class="form-control">
            <option>Male</option>
            <option>Female</option>
          </select>
        </div>
        <div id="modal-dept-group" class="form-group hidden">
          <label>Department</label>
          <select id="newStdDept" class="form-control">
            <option value="Science">Science</option>
            <option value="Art">Art</option>
            <option value="Commercial">Commercial</option>
          </select>
        </div>
        <div class="flex justify-between" style="margin-top: 20px">
          <button class="btn btn-outline" onclick="app.closeModals()">
            Cancel
          </button>
          <button class="btn btn-primary" onclick="app.addStudentConfirm()">
            Save
          </button>
        </div>
      </div>
    </div>

    <div id="modal-print" class="modal-overlay">
      <div class="modal">
        <h3>Print Configuration</h3>
        <div class="form-group">
          <label>Session</label
          ><input
            type="text"
            id="printSession"
            value="2024/2025"
            class="form-control"
          />
        </div>
        <div class="form-group">
          <label>Term</label
          ><select id="printTerm" class="form-control">
            <option>1st</option>
            <option>2nd</option>
            <option>3rd</option>
          </select>
        </div>
        <div class="flex justify-between" style="margin-top: 20px">
          <button class="btn btn-outline" onclick="app.closeModals()">
            Cancel
          </button>
          <button class="btn btn-primary" onclick="app.printReport()">
            Print
          </button>
        </div>
      </div>
    </div>

    <div id="toast" class="toast"><span id="toast-msg"></span></div>
    <div id="printable-area"></div>

    <!-- ================= JAVASCRIPT LOGIC ================= -->
    <script>
      // --- CONSTANTS ---
      const JSS_SUBJECTS = [
        "English",
        "Mathematics",
        "Basic Science",
        "Social Studies",
        "Civic Education",
        "PHE",
        "Basic Technology",
        "Creative Arts",
        "Yoruba",
        "French",
        "Agricultural Science",
        "Computer Studies",
        "Home Economics",
        "CRS/IRS",
        "Business Studies",
      ];
      const SSS_SUBJECTS = {
        All: [
          "English",
          "Mathematics",
          "Civic Education",
          "Economics",
          "Biology",
          "Further Math",
          "Agric Sci",
          "Data Processing",
          "Chemistry",
          "Physics",
          "Geography",
          "Literature",
          "Government",
          "CRS/IRS",
          "Yoruba",
          "Accounting",
          "Commerce",
        ],
        Science: [
          "English",
          "Mathematics",
          "Civic Education",
          "Economics",
          "Chemistry",
          "Physics",
          "Biology",
          "Further Math",
          "Geography",
          "Agric Sci",
          "Data Processing",
        ],
        Art: [
          "English",
          "Mathematics",
          "Civic Education",
          "Economics",
          "Literature",
          "Government",
          "CCA",
          "CRS",
          "Yoruba",
          "Further Math",
          "Biology",
        ],
        Commercial: [
          "English",
          "Mathematics",
          "Civic Education",
          "Accounting",
          "Commerce",
          "Economics",
          "Data Processing",
          "Further Math",
          "Marketing",
        ],
      };
      const ALL_CLASSES = ["JSS1", "JSS2", "JSS3", "SSS1", "SSS2", "SSS3"];

      // --- GOOGLE SHEETS SERVICE ---
      const GoogleSheetService = {
        // PASTE YOUR DEPLOYED WEB APP URL HERE
        URL: "https://script.google.com/macros/s/AKfycbw-GHQzYVauehu_C_0NICw8G2SaNnz1Bu7Ho7V4vPilEuwREzAZaidS10VPlOBB_Xyg/exec",

        _post: async function (action, data = {}) {
          const loader = document.getElementById("loader");
          loader.style.display = "flex"; // Show Loader

          try {
            const response = await fetch(this.URL, {
              method: "POST",
              body: JSON.stringify({ action, ...data }),
            });

            const json = await response.json();
            return json;
          } catch (error) {
            console.error("API Error:", error);
            return { status: "error", message: "Network error" };
          } finally {
            loader.style.display = "none"; // Hide Loader
          }
        },

        login: async function (name, pass) {
          const res = await this._post("login", { name, password: pass });
          if (res.status === "success") {
            return res.user;
          }
          return null;
        },

        signup: async function (userObj) {
          const res = await this._post("signup", {
            title: userObj.title,
            firstName: userObj.firstName,
            lastName: userObj.lastName,
            pass: userObj.pass,
            role: userObj.role,
            assignedClass: userObj.assignedClass || "",
            subjects: userObj.subjects,
          });
          return res.status === "success";
        },

        loadStudents: async function (className) {
          const res = await this._post("getStudents", { className });
          if (res.status === "success") {
            return res.students;
          }
          return [];
        },

        saveAdminUpdate: async function (adminNo, className, scores) {
          return await this._post("saveSingleStudentScores", {
            adminNo: adminNo,
            className: className,
            scores: scores,
          });
        },

        saveScores: async function (user, subjectName, scores) {
          // We use a "fallback" logic: check the user object first, then the global app state
          const className =
            user.viewContext && user.viewContext.cls
              ? user.viewContext.cls
              : app.state.viewContext.cls;

          if (!className) {
            alert(
              "Error: Class name not found. Please try reloading the student list.",
            );
            return false;
          }

          return await this._post("saveScores", {
            user: user,
            subject: subjectName,
            className: className,
            scores: scores,
          });
        },

        saveMidTermScores: async function (user, subjectName, scores) {
          const className =
            user.viewContext && user.viewContext.cls
              ? user.viewContext.cls
              : app.state.viewContext.cls;
          if (!className) {
            alert("Error: Class name not found.");
            return false;
          }
          return await this._post("saveMidTermScores", {
            user: user,
            subject: subjectName,
            className: className,
            scores: scores,
          });
        },

        loadFullResult: async function (adminNo) {
          const res = await this._post("getFullResult", { adminNo });
          if (res.status === "success") {
            return {
              info: res.student,
              scores: res.scores,
            };
          }
          return { info: {}, scores: {} };
        },

        getClassAverages: async function (className, mode) {
          const res = await this._post("getClassAverages", {
            className: className,
            mode: mode,
          });
          if (res.status === "success") {
            return res.averages || {};
          }
          return {};
        },

        addStudent: async function (stdData) {
          const res = await this._post("addStudent", stdData);
          return res.status === "success";
        },
      };

      // --- APP CONTROLLER ---
      const app = {
        state: {
          currentUser: null,
          viewContext: {},
          draftSubjects: [],
          currentDeptFilter: "All",
        },

        init: function () {
          // Removed MockDB.init() because we are using Google Sheets
          const u = sessionStorage.getItem("currentUser");
          if (u) {
            this.state.currentUser = JSON.parse(u);
            this.showDashboard();
          } else
            document.getElementById("view-auth").classList.remove("hidden");
          this.populateSubjects();
        },

        // --- AUTH ---
        switchAuthTab: function (t) {
          document
            .querySelectorAll(".tab-btn")
            .forEach((b) => b.classList.remove("active"));
          event.target.classList.add("active");
          document
            .getElementById("form-login")
            .classList.toggle("hidden", t !== "login");
          document
            .getElementById("form-signup")
            .classList.toggle("hidden", t !== "signup");
        },
        handleRoleChange: function () {
          const r = document.getElementById("signupRole").value;
          document
            .getElementById("class-teacher-group")
            .classList.toggle("hidden", r !== "Class Teacher");
          document
            .getElementById("subject-group")
            .classList.toggle("hidden", r === "Admin" || r === "Head");
        },
        populateSubjects: function () {
          const l = document.getElementById("subjectLevel").value;
          const s = document.getElementById("subjectName");
          const c = document.getElementById("subjectClass");
          s.innerHTML = "<option disabled selected>Subject</option>";
          c.innerHTML = "<option disabled selected>Class</option>";
          if (!l) return;
          const subs = l === "JSS" ? JSS_SUBJECTS : SSS_SUBJECTS.All;
          subs.forEach(
            (sub) => (s.innerHTML += `<option value="${sub}">${sub}</option>`),
          );
          if (l === "JSS")
            c.innerHTML += `<option value="ALL JSS">ALL JSS</option><option value="JSS1">JSS1</option><option value="JSS2">JSS2</option><option value="JSS3">JSS3</option>`;
          else
            c.innerHTML += `<option value="ALL SSS">ALL SSS</option><option value="SSS1">SSS1</option><option value="SSS2">SSS2</option><option value="SSS3">SSS3</option>`;
        },
        addSubject: function () {
          const s = document.getElementById("subjectName").value;
          const c = document.getElementById("subjectClass").value;
          if (!s || !c)
            return this.showToast("Select subject and class", "error");
          this.state.draftSubjects.push({ subject: s, class: c });
          this.renderChips();
        },
        renderChips: function () {
          const l = document.getElementById("chipList");
          l.innerHTML = this.state.draftSubjects
            .map(
              (x, i) =>
                `<div class="subject-chip">${x.subject} (${x.class}) <span onclick="app.state.draftSubjects.splice(${i},1);app.renderChips()">&times;</span></div>`,
            )
            .join("");
        },
        handleSignup: async function (e) {
          e.preventDefault();
          const title = document.getElementById("signupTitle").value;
          const fname = document.getElementById("signupFirstName").value;
          const lname = document.getElementById("signupLastName").value;
          const role = document.getElementById("signupRole").value;
          let cls =
            role === "Class Teacher"
              ? document.getElementById("signupClass").value
              : "";

          if (role === "Class Teacher" && !cls)
            return this.showToast("Select assigned class", "error");
          if (role === "Teacher" && this.state.draftSubjects.length === 0)
            return this.showToast("Add subject", "error");

          const u = {
            name: `${title} ${fname} ${lname}`,
            firstName: fname,
            lastName: lname,
            title: title,
            pass: document.getElementById("signupPass").value,
            role,
            assignedClass: cls,
            subjects: [...this.state.draftSubjects],
          };

          // CALL GOOGLE SHEETS SERVICE
          const success = await GoogleSheetService.signup(u);

          if (success) {
            this.showToast("Account created! Logging you in...", "success");

            // --- AUTO-FILL LOGIN FORM ---
            document.getElementById("loginTitle").value = title;
            document.getElementById("loginFirstName").value = fname;
            document.getElementById("loginLastName").value = lname;

            // --- SWITCH TO LOGIN TAB ---
            // We use a small timeout so the user sees the success toast first
            setTimeout(() => {
              this.switchAuthTab("login");
              // Clear the signup form for security
              document.getElementById("form-signup").reset();
              this.state.draftSubjects = [];
              this.renderChips();

              // Focus on the password field for the user
              document.getElementById("loginPass").focus();
            }, 1500);
          } else {
            this.showToast("Signup failed", "error");
          }
        },
        handleLogin: async function (e) {
          e.preventDefault();
          const title = document.getElementById("loginTitle").value;
          const fname = document.getElementById("loginFirstName").value;
          const lname = document.getElementById("loginLastName").value;
          const pass = document.getElementById("loginPass").value;
          const name = `${title} ${fname} ${lname}`;

          // CALL GOOGLE SHEETS SERVICE
          const u = await GoogleSheetService.login(name, pass);
          if (u) {
            this.state.currentUser = u;
            sessionStorage.setItem("currentUser", JSON.stringify(u));
            this.showToast("Welcome!", "success");
            setTimeout(() => this.showDashboard(), 500);
          } else {
            this.showToast("Invalid credentials", "error");
          }
        },
        logout: function () {
          sessionStorage.removeItem("currentUser");
          window.location.reload();
        },

        // --- DASHBOARD & NAVIGATION ---
        showDashboard: function () {
          document.getElementById("view-auth").classList.add("hidden");
          document.getElementById("view-dashboard").classList.remove("hidden");
          document.getElementById("user-display-name").textContent =
            this.state.currentUser.name;
          document.getElementById("user-display-role").textContent =
            this.state.currentUser.role +
            (this.state.currentUser.assignedClass
              ? ` (${this.state.currentUser.assignedClass})`
              : "");
          this.renderLanding();
        },

        renderLanding: function () {
          const r = this.state.currentUser.role;
          const land = document.getElementById("section-landing");
          land.innerHTML = "";

          // 1. TEACHER (Subject Only)
          if (r === "Teacher") {
            land.innerHTML = `
                    <h2 style="margin-bottom:15px;">My Classes</h2>
                    <div class="flex gap-4" style="margin-bottom:20px;">
                         <button class="btn btn-primary" onclick="app.setTeacherMode('exam')">Exam Mode</button>
                         <button class="btn btn-outline" onclick="app.setTeacherMode('midterm')">Mid-Term Mode</button>
                    </div>
                    <div id="landing-grid" class="dashboard-grid"></div>
                `;
            this.renderClassCards("landing-grid", false);
          }
          // 2. CLASS TEACHER (Hybrid)
          else if (r === "Class Teacher") {
            land.innerHTML = `
                    <div class="card card-lg" onclick="app.loadStudentList('${this.state.currentUser.assignedClass}', 'ClassTeacher')">
                        <div><h2 style="color:var(--primary);">My Class</h2><p class="text-secondary">View results for ${this.state.currentUser.assignedClass}</p></div>
                        <div style="font-size:2rem;">üè´</div>
                    </div>
                    <div class="flex gap-4" style="margin:20px 0;">
                         <button class="btn btn-primary" onclick="app.setTeacherMode('exam')">Exam Mode</button>
                         <button class="btn btn-outline" onclick="app.setTeacherMode('midterm')">Mid-Term Mode</button>
                    </div>
                    <div id="landing-grid" class="dashboard-grid"></div>
                `;
            this.renderClassCards("landing-grid", true);
          }
          // 3. ADMIN / HEAD (Two Sections + Mid-Term Card)
          else {
            land.innerHTML = `
                    <div class="grid-2">
                        <div class="card card-lg" onclick="app.enterAdminMode('manage')" style="border-left-color:var(--success);">
                            <div><h2 style="color:var(--success);">Manage Exam Results</h2><p class="text-secondary">Enter CA & Exam Scores</p></div>
                            <div style="font-size:2rem;">üìÇ</div>
                        </div>
                        <div class="card card-lg" onclick="app.enterAdminMode('check')" style="border-left-color:var(--warning);">
                            <div><h2 style="color:var(--warning);">Check Scores</h2><p class="text-secondary">View Student Profiles</p></div>
                            <div style="font-size:2rem;">üìä</div>
                        </div>
                        <!-- NEW MID-TERM CARD -->
                        <div class="card card-lg" onclick="app.enterAdminMode('midterm')" style="border-left-color:var(--primary);">
                            <div><h2 style="color:var(--primary);">Manage Mid-Term</h2><p class="text-secondary">Enter Single Scores (100)</p></div>
                            <div style="font-size:2rem;">üìù</div>
                        </div>
                        <!-- CHECK MID-TERM (NEW) -->
                        <div class="card card-lg" onclick="app.enterAdminMode('check-midterm')" style="border-left-color:var(--warning);">
                            <div><h2 style="color:var(--warning);">Check Mid-Term Results</h2><p class="text-secondary">View Profiles & Scores</p></div>
                            <div style="font-size:2rem;">üìù</div>
                        </div>
                    </div>
                `;
          }
        },

        // Renders Class Cards based on Subject List
        renderClassCards: function (containerId, excludeAssigned) {
          const cont = document.getElementById(containerId);
          if (!cont) return;

          const visibleClasses = new Set();
          this.state.currentUser.subjects.forEach((s) => {
            if (s.class === "ALL JSS")
              ["JSS1", "JSS2", "JSS3"].forEach((c) => visibleClasses.add(c));
            else if (s.class === "ALL SSS")
              ["SSS1", "SSS2", "SSS3"].forEach((c) => visibleClasses.add(c));
            else visibleClasses.add(s.class);
          });

          if (excludeAssigned)
            visibleClasses.delete(this.state.currentUser.assignedClass);

          Array.from(visibleClasses)
            .sort()
            .forEach((cls) => {
              const isJSS = cls.startsWith("JSS");
              cont.innerHTML += `
                    <div class="card" onclick="app.loadSubjectList('${cls}')">
                        <div class="flex justify-between">
                            <h3>${cls}</h3>
                            <span class="badge ${isJSS ? "badge-jss" : "badge-sss"}">${isJSS ? "JSS" : "SSS"}</span>
                        </div>
                        <p class="text-secondary">Select Subject</p>
                    </div>`;
            });
        },

        // --- FLOWS ---

        // 1. TEACHER / ADMIN MANAGE: Select Class
        enterAdminMode: function (mode) {
          this.state.viewContext.mode = mode;

          // --- MANAGE MODES (Exam or Mid-Term Entry) ---
          if (mode === "manage" || mode === "midterm") {
            const title =
              mode === "midterm"
                ? "Select Class for Mid-Term"
                : "Select Class to Manage";
            const actionText = "Manage Students";

            document.getElementById("list-title").textContent = title;
            document.getElementById("breadcrumb-action").textContent =
              actionText;
            document.getElementById("class-grid").innerHTML = "";
            ALL_CLASSES.forEach((cls) => {
              const subText =
                mode === "midterm" ? "Manage Mid-Term" : "Manage Subjects";
              document.getElementById("class-grid").innerHTML +=
                `<div class="card" onclick="app.loadSubjectList('${cls}')"><h3>${cls}</h3><p>${subText}</p></div>`;
            });
            this.showSection("section-class-list");
          }
          // --- CHECK MODES (View Only) ---
          else {
            if (mode === "check-midterm") {
              // CHECK MID-TERM MODE
              document.getElementById("list-title").textContent =
                "Select Class to View Mid-Term";
              document.getElementById("breadcrumb-action").textContent =
                "Check Mid-Term";
              document.getElementById("class-grid").innerHTML = "";
              ALL_CLASSES.forEach((cls) => {
                document.getElementById("class-grid").innerHTML +=
                  `<div class="card" onclick="app.loadStudentList('${cls}', 'check-midterm')"><h3>${cls}</h3><p>View Mid-Term Results</p></div>`;
              });
            } else {
              // CHECK EXAM MODE
              document.getElementById("list-title").textContent =
                "Select Class to View";
              document.getElementById("breadcrumb-action").textContent =
                "Check Scores";
              document.getElementById("class-grid").innerHTML = "";
              ALL_CLASSES.forEach((cls) => {
                document.getElementById("class-grid").innerHTML +=
                  `<div class="card" onclick="app.loadStudentList('${cls}', 'Admin')"><h3>${cls}</h3><p>View Students</p></div>`;
              });
            }
            this.showSection("section-class-list");
          }
        },

        // 2. SELECT SUBJECT LIST (Used by Teacher, Class Teacher, Admin Manage)
        loadSubjectList: function (clsName) {
          this.state.viewContext.cls = clsName;
          document.getElementById("crumb-class-name").textContent = clsName;

          const filterContainer = document.getElementById(
            "dept-filter-container",
          );
          if (
            clsName.startsWith("SSS") &&
            this.state.viewContext.mode === "manage"
          ) {
            filterContainer.classList.remove("hidden");
            filterContainer.style.display = "flex";
            this.state.currentDeptFilter = "All";
            this.updateDeptButtons("All");
          } else {
            filterContainer.classList.add("hidden");
            filterContainer.style.display = "none";
          }

          this.renderSubjectGrid(clsName);
          this.showSection("section-subject-list");
        },

        // DEPARTMENT FILTER LOGIC (ADMIN ONLY)
        filterSSSSubjects: function (dept, btnElement) {
          this.state.currentDeptFilter = dept;
          this.updateDeptButtons(dept);
          this.renderSubjectGrid(this.state.viewContext.cls);
        },

        updateDeptButtons: function (activeDept) {
          document.querySelectorAll(".btn-filter").forEach((btn) => {
            if (btn.innerText === activeDept) btn.classList.add("active");
            else btn.classList.remove("active");
          });
        },

        renderSubjectGrid: function (clsName) {
          const grid = document.getElementById("subject-grid");
          grid.innerHTML = "";

          let subsToShow = [];

          // LOGIC: Admin Mode vs Teacher Mode
          if (
            this.state.viewContext.mode === "manage" ||
            this.state.viewContext.mode === "midterm"
          ) {
            if (clsName.startsWith("JSS")) {
              subsToShow = JSS_SUBJECTS;
            } else {
              subsToShow =
                SSS_SUBJECTS[this.state.currentDeptFilter] || SSS_SUBJECTS.All;
            }
          } else {
            // TEACHER MODE: Show only what user teaches
            const userSubs = this.state.currentUser.subjects
              .filter(
                (s) =>
                  s.class === clsName ||
                  (s.class === "ALL JSS" && clsName.startsWith("JSS")) ||
                  (s.class === "ALL SSS" && clsName.startsWith("SSS")),
              )
              .map((s) => s.subject);
            subsToShow = [...new Set(userSubs)];
          }

          if (subsToShow.length === 0) {
            grid.innerHTML =
              '<p style="grid-column:1/-1; text-align:center;">No subjects found.</p>';
          } else {
            subsToShow.forEach((sub) => {
              grid.innerHTML += `<div class="card" onclick="app.loadBatchEntry('${clsName}', '${sub}')"><h3>${sub}</h3><p>Enter Scores</p></div>`;
            });
          }
        },

        // 3. BATCH ENTRY (Subject-based)
        // 3. BATCH ENTRY (Subject-based)
        loadBatchEntry: async function (cls, sub) {
          this.state.viewContext.cls = cls;
          this.state.viewContext.sub = sub;
          document.getElementById("batch-crumb-class").textContent = cls;
          document.getElementById("batch-crumb-subject").textContent = sub;

          // 1. DETERMINE MODE
          const isMidTerm = this.state.viewContext.mode === "midterm";
          const modeTitle = isMidTerm
            ? "Mid-Term Scores (100%)"
            : "Exam Scores (CA + Exam)";
          document.querySelector("#section-batch-entry h2").textContent =
            modeTitle;

          // 2. DYNAMIC HEADERS (New Fix)
          const headerRow = document.getElementById("batch-headers");
          if (isMidTerm) {
            headerRow.innerHTML = `
            <th>Admin No</th>
            <th>Name</th>
            <th>Score (100)</th>
            <th>Grade</th>
        `;
          } else {
            headerRow.innerHTML = `
            <th>Admin No</th>
            <th>Name</th>
            <th>CA (40)</th>
            <th>Exam (60)</th>
            <th>Total (100)</th>
        `;
          }

          const acts = document.getElementById("batch-actions");
          if (
            this.state.currentUser.role === "Admin" ||
            this.state.currentUser.role === "Head"
          ) {
            acts.innerHTML = `<button class="btn btn-primary" onclick="app.openAddStudentModal('${cls}')">+ Add Student</button>`;
          } else {
            acts.innerHTML = "";
          }

          const stds = await GoogleSheetService.loadStudents(cls);
          const tbody = document.getElementById("batch-rows");
          tbody.innerHTML = "";

          if (stds && stds.length > 0) {
            stds.forEach((s) => {
              // Load scores based on mode
              const score = s.scores[sub] || {};
              let rowContent = "";
              let mobileLabel = ""; // For fixing the mobile view labels

              if (isMidTerm) {
                // MID-TERM ROW: Single Input
                const val = score.total !== undefined ? score.total : "";
                const grade = this.getMidTermGrade(
                  val,
                  s.class.startsWith("JSS"),
                );
                // Add label for mobile CSS
                mobileLabel = 'data-label="Score (100)"';

                rowContent = `
                            <td ${mobileLabel}><input type="number" class="score-input-mini input-midterm" min="0" max="100" value="${val}"></td>
                            <td data-label="Grade"><span class="badge" style="font-weight:bold;">${grade}</span></td>
                        `;
              } else {
                // EXAM ROW: CA + Exam
                const ca = score.ca !== undefined ? score.ca : "";
                const ex = score.exam !== undefined ? score.exam : "";
                const total = (parseInt(ca) || 0) + (parseInt(ex) || 0);
                rowContent = `
                            <td data-label="CA (40)"><input type="number" class="score-input-mini input-ca" min="0" max="40" value="${ca}"></td>
                            <td data-label="Exam (60)"><input type="number" class="score-input-mini input-exam" min="0" max="60" value="${ex}"></td>
                            <td data-label="Total"><span class="total-mini">${total}</span></td>
                        `;
              }

              tbody.innerHTML += `
                        <tr data-sid="${s.id}">
                            <td data-label="Admin No">${s.id}</td>
                            <td data-label="Name">${s.name}</td>
                            ${rowContent}
                        </tr>
                    `;
            });
          } else {
            tbody.innerHTML =
              '<tr><td colspan="5" style="text-align:center;">No students found in this class.</td></tr>';
          }

          // Add Listeners for Auto-Calculation
          if (isMidTerm) {
            document.querySelectorAll(".input-midterm").forEach((inp) => {
              inp.addEventListener("input", (e) => {
                const val = parseInt(e.target.value) || 0;
                const r = e.target.closest("tr");
                r.querySelector(".badge").textContent = this.getMidTermGrade(
                  val,
                  s.class.startsWith("JSS"),
                );
              });
            });
          } else {
            document.querySelectorAll(".score-input-mini").forEach((inp) => {
              inp.addEventListener("input", (e) => {
                const r = e.target.closest("tr");
                const ca = parseInt(r.querySelector(".input-ca").value) || 0;
                const ex = parseInt(r.querySelector(".input-exam").value) || 0;
                r.querySelector(".total-mini").textContent = ca + ex;
              });
            });
          }

          this.showSection("section-batch-entry");
        },

        // HELPER FOR MID-TERM GRADING
        getMidTermGrade: function (score, isJSS) {
          if (score >= 80) return "A";
          if (score >= 70) return "B";
          if (score >= 60) return "BC";
          if (score >= 50) return "C";
          if (score >= 40) return "P";
          return "F";
        },

        saveBatchScores: async function () {
          const rows = document.querySelectorAll("#batch-rows tr");
          const scores = {};
          const subjectName = this.state.viewContext.sub;
          const isMidTerm = this.state.viewContext.mode === "midterm";

          rows.forEach((row) => {
            const sid = row.dataset.sid;
            if (sid) {
              if (isMidTerm) {
                // Save Single Total
                const total = row.querySelector(".input-midterm").value;
                scores[sid] = { total: parseInt(total) || 0 };
              } else {
                // Save CA & Exam
                const ca = row.querySelector(".input-ca").value;
                const exam = row.querySelector(".input-exam").value;
                scores[sid] = {
                  ca: parseInt(ca) || 0,
                  exam: parseInt(exam) || 0,
                };
              }
            }
          });

          let success;
          // Call different API based on mode
          if (isMidTerm) {
            success = await GoogleSheetService.saveMidTermScores(
              this.state.user,
              subjectName,
              scores,
            );
          } else {
            success = await GoogleSheetService.saveScores(
              this.state.user,
              subjectName,
              scores,
            );
          }

          if (success) {
            const modeText = isMidTerm ? "Mid-Term" : "Exam";
            this.showToast(`${modeText} scores saved successfully`, "success");
            this.loadBatchEntry(this.state.viewContext.cls, subjectName);
          } else {
            this.showToast("Failed to save scores", "error");
          }
        },

        // 4. STUDENT LIST (For Class Teachers / Admin Check Scores)
        loadStudentList: async function (cls, mode) {
          this.state.viewContext.cls = cls;
          this.state.viewContext.mode = mode;
          document.getElementById("std-list-crumb-cls").textContent = cls;

          // CALL GOOGLE SHEETS SERVICE
          const stds = await GoogleSheetService.loadStudents(cls);

          const tbody = document.getElementById("std-list-rows");
          tbody.innerHTML = "";

          if (stds && stds.length > 0) {
            stds.forEach((s) => {
              tbody.innerHTML += `<tr><td>${s.id}</td><td>${s.name}</td><td><button class="btn btn-sm btn-outline" onclick="app.loadStudentDetail('${s.id}')">View Profile</button></td></tr>`;
            });
          } else {
            tbody.innerHTML =
              '<tr><td colspan="3" style="text-align:center;">No students found.</td></tr>';
          }
          this.showSection("section-student-list");
          // In loadStudentList function, after setting up the table
          if (this.state.viewContext.mode === "check-midterm") {
            const headerDiv = document.querySelector(
              "#section-student-list .flex.justify-between",
            );
            if (headerDiv && !document.getElementById("print-all-btn")) {
              const printAllBtn = document.createElement("button");
              printAllBtn.id = "print-all-btn";
              printAllBtn.className = "btn btn-primary";
              printAllBtn.textContent = "Print All Reports";
              printAllBtn.onclick = () => app.printAllClassReports();
              headerDiv.appendChild(printAllBtn);
            }
          }
        },

        filterStudentList: function () {
          const q = document.getElementById("std-search").value.toLowerCase();
          const rows = document.querySelectorAll("#std-list-rows tr");
          rows.forEach((r) => {
            r.style.display = r.innerText.toLowerCase().includes(q)
              ? ""
              : "none";
          });
        },

        // 5. STUDENT DETAIL (All subjects, Permission based editing)
        loadStudentDetail: async function (sid) {
          const result = await GoogleSheetService.loadFullResult(sid);

          if (!result || !result.info) {
            this.showToast("Error loading student data", "error");
            return;
          }

          const s = result.info;
          s.scores = result.scores; // Attach scores
          this.state.viewContext.sid = sid;

          document.getElementById("det-crumb-cls").textContent = s.class;
          document.getElementById("det-crumb-name").textContent = s.name;
          document.getElementById("det-name").textContent = s.name;
          document.getElementById("det-info").textContent =
            `ID: ${s.id} ${s.dept ? "| Dept: " + s.dept : ""}`;
          document.getElementById("det-avatar").textContent = s.name
            .substring(0, 2)
            .toUpperCase();

          const u = this.state.currentUser;
          const isJSS = s.class.startsWith("JSS");
          const allSubs = isJSS ? JSS_SUBJECTS : SSS_SUBJECTS.All;

          const isMidTerm =
            this.state.viewContext.mode === "midterm" ||
            this.state.viewContext.mode === "check-midterm";

          const container = document.getElementById("det-score-rows");
          container.innerHTML = "";

          // ‚îÄ‚îÄ IMPORTANT: Declare permission & readonly variable EARLY ‚îÄ‚îÄ
          const canEditOverall = u.role === "Admin" || u.role === "Head";

          allSubs.forEach((sub) => {
            // Determine if THIS subject can be edited
            let canEditThisSubject = canEditOverall;

            if (!canEditOverall && u.role === "Class Teacher") {
              canEditThisSubject = u.subjects.some(
                (subj) => subj.subject === sub,
              );
            }

            // Now safe to define ro
            const ro = canEditThisSubject ? "" : "disabled";
            const lbl = canEditThisSubject
              ? ""
              : '<span class="readonly-badge">Read-only</span>';

            let score, total, rowContent;

            if (isMidTerm) {
              score = s.scores[sub] || { total: "" };
              total = parseInt(score.total) || 0;
              const grade = this.getMidTermGrade(total, isJSS);

              rowContent = `
            <div>
                <input type="number" class="score-input input-midterm"
                       min="0" max="100" value="${score.total || ""}"
                       ${ro}>
            </div>
            <div style="font-weight:bold; text-align:center; padding:10px 0;">
                ${grade}
            </div>
        `;
            } else {
              score = s.scores[sub] || { ca: "", exam: "" };
              total = (parseInt(score.ca) || 0) + (parseInt(score.exam) || 0);

              rowContent = `
            <div>
                <input type="number" class="score-input input-ca"
                       min="0" max="40" value="${score.ca || ""}"
                       ${ro}>
            </div>
            <div>
                <input type="number" class="score-input input-exam"
                       min="0" max="60" value="${score.exam || ""}"
                       ${ro}>
            </div>
            <div style="font-weight:bold; text-align:center;">
                ${total || "-"}
            </div>
        `;
            }

            container.innerHTML += `
        <div class="score-row">
            <div class="subject-label">${sub} ${lbl}</div>
            ${rowContent}
        </div>
    `;
          });

          // Add input listeners (only for editable fields)
          document
            .querySelectorAll(".score-input:not([disabled])")
            .forEach((inp) => {
              inp.addEventListener("input", (e) => {
                const row = e.target.closest(".score-row");
                if (!row) return;

                if (isMidTerm) {
                  // mid-term doesn't need live total update in detail view
                } else {
                  const ca =
                    parseInt(row.querySelector(".input-ca")?.value) || 0;
                  const ex =
                    parseInt(row.querySelector(".input-exam")?.value) || 0;
                  row.lastElementChild.textContent = ca + ex;
                }
              });
            });

          this.showSection("section-student-detail");
        },

        saveStudentDetail: async function () {
          const sid = this.state.viewContext.sid;
          const u = this.state.currentUser;
          const rows = document.querySelectorAll("#det-score-rows .score-row");
          const updates = {};

          rows.forEach((r) => {
            const labelDiv = r.querySelector(".subject-label");
            const sub = labelDiv.firstChild.textContent.trim();
            const ca = r.querySelector(".input-ca").value;
            const ex = r.querySelector(".input-exam").value;

            let canEdit = false;
            if (u.role === "Admin" || u.role === "Head") canEdit = true;
            else if (
              u.role === "Class Teacher" &&
              u.subjects.some((s) => s.subject === sub)
            )
              canEdit = true;

            if (canEdit) {
              updates[sub] = { ca: parseInt(ca) || 0, exam: parseInt(ex) || 0 };
            }
          });

          // CALL GOOGLE SHEETS SERVICE TO SAVE
          // Note: For student detail, we save to the specific subject sheets that were edited
          // The backend `saveScores` handles splitting updates into subject sheets automatically

          const success = await GoogleSheetService.saveScores(
            u,
            this.state.viewContext.cls,
            updates,
          );

          if (success) {
            this.showToast("Changes Saved", "success");
          } else {
            this.showToast("Error saving changes", "error");
          }
        },

        // Add this new function to the 'app' object

        saveStudentScores: async function () {
          const adminNo = this.state.printAdminNo;
          const className = document.getElementById("res-class").textContent;
          const rows = document.querySelectorAll("#res-table-body tr");
          const scores = {};

          rows.forEach((row) => {
            const sub = row.cells[0].textContent;
            const ca = row.querySelector(".input-ca").value;
            const exam = row.querySelector(".input-exam").value;
            if (sub) {
              scores[sub] = { ca: ca || 0, exam: exam || 0 };
            }
          });

          // This calls the Admin-specific saving logic
          const success = await GoogleSheetService._post(
            "saveSingleStudentScores",
            {
              adminNo: adminNo,
              className: className,
              scores: scores,
            },
          );

          if (success.status === "success") {
            this.showToast("Admin override saved successfully!", "success");
          } else {
            this.showToast("Error saving admin scores", "error");
          }
        },

        closeStudentDetail: function () {
          this.loadStudentList(
            this.state.viewContext.cls,
            this.state.viewContext.mode,
          );
        },

        // --- UTILS ---
        showSection: function (id) {
          document
            .querySelectorAll("main section")
            .forEach((s) => s.classList.add("hidden"));
          document.getElementById(id).classList.remove("hidden");
        },
        goHome: function () {
          this.showSection("section-landing");
        },
        openAddStudentModal: function (cls) {
          this.state.viewContext.tempClass = cls;
          document.getElementById("modal-add-student").style.display = "flex";
          document
            .getElementById("modal-dept-group")
            .classList.toggle("hidden", !cls.startsWith("SSS"));
        },
        addStudentConfirm: async function () {
          const name = document.getElementById("newStdName").value;
          const id = document.getElementById("newStdId").value;
          const gender = document.getElementById("newStdGender").value;
          const dept = document.getElementById("newStdDept").value;
          if (!name || !id) return this.showToast("Missing fields", "error");

          const stdData = {
            id,
            name,
            gender,
            class: this.state.viewContext.tempClass,
            dept: this.state.viewContext.tempClass.startsWith("SSS")
              ? dept
              : "",
          };

          // CALL GOOGLE SHEETS SERVICE
          const success = await GoogleSheetService.addStudent(stdData);

          if (success) {
            this.showToast("Student Added", "success");
            this.closeModals();
            // Refresh current view
            if (this.state.viewContext.sub)
              this.loadBatchEntry(
                this.state.viewContext.cls,
                this.state.viewContext.sub,
              );
            else this.loadStudentList(this.state.viewContext.cls, "Admin");
          } else {
            this.showToast("Error adding student", "error");
          }
        },
        openPrintModal: function () {
          document.getElementById("modal-print").style.display = "flex";
        },
        closeModals: function () {
          document
            .querySelectorAll(".modal-overlay")
            .forEach((m) => (m.style.display = "none"));
        },

        // --- FINAL PRINT FUNCTION ---
        printReport: async function () {
          const session = document.getElementById("printSession").value;
          const term = document.getElementById("printTerm").value;
          const sid = this.state.printAdminNo || this.state.viewContext.sid;

          const result = await GoogleSheetService.loadFullResult(sid);
          if (!result || !result.info)
            return this.showToast("Error loading report", "error");

          const s = result.info;
          const scores = result.scores;
          const isJSS = s.class.startsWith("JSS");

          const isMidTerm =
            this.state.viewContext.mode === "midterm" ||
            this.state.viewContext.mode === "check-midterm";

          // --- SMART SUBJECT LIST SELECTION ---
          let subjectsList;
          if (isJSS) {
            subjectsList = JSS_SUBJECTS;
          } else {
            if (s.dept && SSS_SUBJECTS[s.dept]) {
              subjectsList = SSS_SUBJECTS[s.dept];
            } else {
              subjectsList = SSS_SUBJECTS.All;
            }
          }

          // --- CALCULATE TOTAL & PERCENTAGE ---
          let grandTotalScore = 0;
          let validSubjectCount = 0;

          subjectsList.forEach((sub) => {
            let sc;
            if (isMidTerm) {
              sc = scores[sub] || { total: "" };
              const total = Number(sc.total) || 0;
              if (total > 0) {
                grandTotalScore += total;
                validSubjectCount++;
              }
            } else {
              sc = scores[sub] || { ca: "", exam: "" };
              const total = (Number(sc.ca) || 0) + (Number(sc.exam) || 0);
              if (total > 0) {
                grandTotalScore += total;
                validSubjectCount++;
              }
            }
          });

          const maxObtainable = validSubjectCount * 100;
          const overallPercentage =
            validSubjectCount > 0
              ? ((grandTotalScore / maxObtainable) * 100).toFixed(0)
              : 0;

          // --- PRINCIPAL'S COMMENT ---
          let principalComment = "";
          if (overallPercentage >= 80)
            principalComment = "This is an exceptional performance";
          else if (overallPercentage >= 70)
            principalComment = "This is a resourceful child";
          else if (overallPercentage >= 60)
            principalComment = "This is an encouraging performance";
          else if (overallPercentage >= 50)
            principalComment = "This is a promising child";
          else if (overallPercentage >= 40)
            principalComment = "This result is below average";
          else principalComment = "This is a very poor performance";

          // --- TEACHER'S COMMENT ---
          const teacherComments = [
            "has shown excellent ability to set goals and be persistent in achieving them.",
            "is interested in learning, listens attentively, and makes a solid effort to avoid distractions.",
            "is accountable and responsible, makes smart decisions, and admits mistakes.",
            "relates well to classmates and is appreciative of different perspectives and experiences.",
            "excels at applying what is learned in the classroom to real-world and real-life situations.",
            "has brought enthusiasm, positivity, and maturity to class, making it a pleasure to teach.",
          ];
          const randomTeacherComment =
            teacherComments[Math.floor(Math.random() * teacherComments.length)];

          const area = document.getElementById("printable-area");

          if (isMidTerm) {
            // ‚îÄ‚îÄ MID-TERM LAYOUT ‚îÄ‚îÄ
            const getMidTermGradeInfo = (total) => {
              if (total >= 80) return { g: "A", c: "Distinction" };
              if (total >= 70) return { g: "B", c: "Excellent" };
              if (total >= 60) return { g: "BC", c: "Very Good" };
              if (total >= 50) return { g: "C", c: "Good" };
              if (total >= 40) return { g: "P", c: "Pass" };
              return { g: "F", c: "Fail" };
            };

            // Load class averages
            const classAverages = await GoogleSheetService.getClassAverages(
              s.class,
              "midterm",
            );

            area.innerHTML = `
      <style>
        @media print {
          @page { margin: 12mm; size: A4; }
          body { -webkit-print-color-adjust: exact; }
          .rp-table td, .rp-table th { font-size: 0.85rem !important; }
          .report-card { font-size: 0.9rem; }
        }
      </style>

      <div class="report-card">
        <!-- HEADER -->
        <div class="rp-header" style="display: flex; align-items: center; justify-content: center; margin-bottom: 12px; gap: 20px;">
          <img src="https://z-cdn-media.chatglm.cn/files/cc741a52-6dc8-4d89-97cb-fdf1a87aa38a.png?auth_key=1868210321-d7534ff785814de88115631510ed5dbc-0-0d208a01c26657a242308b62449ab19b"
               alt="Nifty Steps Logo"
               style="width: 70px; height: 70px; object-fit: contain;">
          <div style="text-align: left;">
            <h1 style="color: #1e40af; margin: 0 0 4px 0; line-height: 1.1; font-size: 1.6rem;">NIFTY STEPS COLLEGE</h1>
            <p style="font-size: 0.85rem; margin: 0; line-height: 1.3;">31 Yinka Ogunfile Street, Igbo Oluwo Estate, Ikorodu, Lagos State</p>
            <p style="font-size: 0.8rem; margin: 0;">www.niftysteps.com.ng | admin@niftysteps.com.ng</p>
            <h3 style="margin: 8px 0 0 0; text-decoration: underline; text-transform: uppercase; font-size: 0.95rem;">
              ${isJSS ? "Junior" : "Senior"} Secondary School ${term} MID-TERM REPORT SHEET
            </h3>
          </div>
        </div>

        <!-- STUDENT INFO -->
        <div style="display: flex; justify-content: space-between; border: 1px solid #000; padding: 8px; margin-bottom: 20px;">
          <div style="line-height: 1.5;">
            <strong>NAME:</strong> ${s.name.toUpperCase()}<br>
            <strong>CLASS:</strong> ${s.class} ${s.dept ? `(${s.dept})` : ""}
          </div>
          <div style="line-height: 1.5; text-align: right;">
            <strong>ADMIN NO:</strong> ${s.id}<br>
            <strong>SESSION:</strong> ${session}
          </div>
        </div>

        <!-- MAIN TABLE -->
        <table class="rp-table" style="width: 100%; border-collapse: collapse; border: 1px solid #000; font-size: 0.85rem; margin-bottom: 20px;">
          <thead>
            <tr style="background: #e2e8f0;">
              <th style="border: 1px solid #000; padding: 5px; text-align: left;">SUBJECTS</th>
              <th style="border: 1px solid #000; padding: 5px;">MARK OBTAINABLE</th>
              <th style="border: 1px solid #000; padding: 5px;">MARK OBTAINED</th>
              <th style="border: 1px solid #000; padding: 5px;">CLASS AVG</th>
              <th style="border: 1px solid #000; padding: 5px;">GRADE</th>
              <th style="border: 1px solid #000; padding: 5px; text-align: left;">COMMENT</th>
            </tr>
          </thead>
          <tbody>
            ${subjectsList
              .map((sub) => {
                const sc = scores[sub] || { total: "" };
                const total = Number(sc.total) || 0;
                const gradeInfo = getMidTermGradeInfo(total);
                const show = total > 0;
                const avg = classAverages[sub]
                  ? Math.round(classAverages[sub])
                  : "-";
                return `
                <tr>
                <td style="border: 1px solid #000; padding: 5px;">${sub}</td>
                <td style="border: 1px solid #000; padding: 5px; text-align: center;">100</td>
                <td style="border: 1px solid #000; padding: 5px; text-align: center;">${show ? total : "-"}</td>
                <td style="border: 1px solid #000; padding: 5px; text-align: center;">${avg}</td>
                <td style="border: 1px solid #000; padding: 5px; text-align: center; font-weight: bold;">${show ? gradeInfo.g : "-"}</td>
                <td style="border: 1px solid #000; padding: 5px;">${show ? gradeInfo.c : "-"}</td>
              </tr>`;
              })
              .join("")}

            <!-- TOTAL / PERCENTAGE ROW -->
          <tr style="background-color: #f1f5f9; font-weight: bold;">
            <td style="border: 1px solid #000; padding: 5px;" colspan="2">TOTAL:</td>
            <td style="border: 1px solid #000; padding: 5px; text-align: center;">${grandTotalScore}</td>
            <td style="border: 1px solid #000; padding: 5px; text-align: center;" colspan="2">PERCENTAGE (%):</td>
            <td style="border: 1px solid #000; padding: 5px; text-align: center;">${overallPercentage}%</td>
          </tr>
          </tbody>
        </table>

        <!-- GRADING & COMMENT SYSTEMS -->
        <div style="display: flex; justify-content: space-between; gap: 20px; margin-bottom: 20px;">
          <div style="width: 48%;">
            <strong>Grading System</strong>
            <table style="width: 100%; border-collapse: collapse; border: 1px solid #000; font-size: 0.8rem;">
              <tr><td style="border: 1px solid #000; padding: 4px;">80 - 100%</td><td style="border: 1px solid #000; padding: 4px;">A</td><td style="border: 1px solid #000; padding: 4px;">70 - 79%</td><td style="border: 1px solid #000; padding: 4px;">B</td></tr>
              <tr><td style="border: 1px solid #000; padding: 4px;">60 - 69%</td><td style="border: 1px solid #000; padding: 4px;">BC</td><td style="border: 1px solid #000; padding: 4px;">50 - 59%</td><td style="border: 1px solid #000; padding: 4px;">C</td></tr>
              <tr><td style="border: 1px solid #000; padding: 4px;">40 - 49%</td><td style="border: 1px solid #000; padding: 4px;">P</td><td style="border: 1px solid #000; padding: 4px;">0 - 39%</td><td style="border: 1px solid #000; padding: 4px;">F</td></tr>
            </table>
          </div>
          <div style="width: 48%;">
            <strong>Comment System</strong>
            <table style="width: 100%; border-collapse: collapse; border: 1px solid #000; font-size: 0.8rem;">
              <tr><td style="border: 1px solid #000; padding: 4px;">A</td><td style="border: 1px solid #000; padding: 4px;">Distinction</td><td style="border: 1px solid #000; padding: 4px;">B</td><td style="border: 1px solid #000; padding: 4px;">Excellent</td></tr>
              <tr><td style="border: 1px solid #000; padding: 4px;">BC</td><td style="border: 1px solid #000; padding: 4px;">Very Good</td><td style="border: 1px solid #000; padding: 4px;">C</td><td style="border: 1px solid #000; padding: 4px;">Good</td></tr>
              <tr><td style="border: 1px solid #000; padding: 4px;">P</td><td style="border: 1px solid #000; padding: 4px;">Pass</td><td style="border: 1px solid #000; padding: 4px;">F</td><td style="border: 1px solid #000; padding: 4px;">Fail</td></tr>
            </table>
          </div>
        </div>

        <!-- COMMENTS -->
        <div style="margin-top: 20px; display: flex; justify-content: space-between; gap: 20px;">
          <div style="font-size: 0.85rem; border: 1px solid #000; padding: 10px; width: 60%;">
            <strong>TEACHER'S COMMENT:</strong><br>
            ${s.name.charAt(0).toUpperCase() + s.name.slice(1)} ${randomTeacherComment}
          </div>
          <div style="font-size: 0.85rem; border: 1px solid #000; padding: 10px; width: 38%;">
            <strong>PRINCIPAL'S COMMENT:</strong><br>
            ${principalComment}
          </div>
        </div>

        <div style="margin-top: 25px; text-align: right;">
          <div style="border-bottom: 1px solid #000; width: 170px; height: 50px; margin-left: auto;"></div>
          <p style="font-size: 0.8rem; margin-top: 5px;">Principal's Signature</p>
        </div>
      </div>
    `;
          } else {
            // Exam layout remains the same (unchanged)
            // ... keep your existing exam print code here ...
          }

          this.closeModals();
          setTimeout(() => {
            window.print();
          }, 500);
        },

        showToast: function (m, t) {
          const x = document.getElementById("toast");
          document.getElementById("toast-msg").textContent = m;
          x.className = `toast show ${t}`;
          setTimeout(() => x.classList.remove("show"), 3000);
        },

        printAllClassReports: async function () {
          const cls = this.state.viewContext.cls;
          if (!cls) {
            this.showToast("No class selected", "error");
            return;
          }

          // Reuse existing print modal for session & term
          this.openPrintModal();

          // We'll override the Print button behavior temporarily
          const originalPrintBtn = document.querySelector(
            "#modal-print .btn-primary",
          );
          const originalOnClick = originalPrintBtn.onclick;

          originalPrintBtn.onclick = async () => {
            const session = document.getElementById("printSession").value;
            const term = document.getElementById("printTerm").value;

            this.closeModals();
            this.showToast(
              "Preparing class reports... (this may take a moment)",
              "success",
            );

            // 1. Load all students in class
            const studentsRes = await GoogleSheetService.loadStudents(cls);
            if (!studentsRes || studentsRes.length === 0) {
              this.showToast("No students found in class", "error");
              return;
            }

            const printable = document.getElementById("printable-area");
            printable.innerHTML = ""; // clear previous content

            // Add global print styles once
            printable.innerHTML += `
      <style>
        @media print {
          @page { margin: 12mm; size: A4; }
          body { -webkit-print-color-adjust: exact; }
          .student-report { page-break-after: always; }
          .student-report:last-child { page-break-after: avoid; }
          .rp-table td, .rp-table th { font-size: 0.80rem !important; padding: 4px !important; }
        }
      </style>
    `;

            // Process each student one by one
            for (const student of studentsRes) {
              const sid = student.id;

              // Reuse the same logic as single print
              const result = await GoogleSheetService.loadFullResult(sid);
              if (!result || !result.info) continue;

              const s = result.info;
              s.scores = result.scores;
              const isJSS = s.class.startsWith("JSS");

              // Subject list (same as before)
              let subjectsList = isJSS
                ? JSS_SUBJECTS
                : s.dept && SSS_SUBJECTS[s.dept]
                  ? SSS_SUBJECTS[s.dept]
                  : SSS_SUBJECTS.All;

              // Calculate totals (mid-term only in this case)
              let grandTotalScore = 0;
              let validSubjectCount = 0;

              subjectsList.forEach((sub) => {
                const sc = s.scores[sub] || { total: "" };
                const total = Number(sc.total) || 0;
                if (total > 0) {
                  grandTotalScore += total;
                  validSubjectCount++;
                }
              });

              const maxObtainable = validSubjectCount * 100;
              const overallPercentage =
                validSubjectCount > 0
                  ? ((grandTotalScore / maxObtainable) * 100).toFixed(0)
                  : 0;

              // Principal & Teacher comments (same logic)
              let principalComment = "";
              if (overallPercentage >= 80)
                principalComment = "This is an exceptional performance";
              else if (overallPercentage >= 70)
                principalComment = "This is a resourceful child";
              else if (overallPercentage >= 60)
                principalComment = "This is an encouraging performance";
              else if (overallPercentage >= 50)
                principalComment = "This is a promising child";
              else if (overallPercentage >= 40)
                principalComment = "This result is below average";
              else principalComment = "This is a very poor performance";

              const teacherComments = [
                /* same array as before */
              ];
              const randomTeacherComment =
                teacherComments[
                  Math.floor(Math.random() * teacherComments.length)
                ];

              // Grade helper
              const getMidTermGradeInfo = (total) => {
                if (total >= 80) return { g: "A", c: "Distinction" };
                if (total >= 70) return { g: "B", c: "Excellent" };
                if (total >= 60) return { g: "BC", c: "Very Good" };
                if (total >= 50) return { g: "C", c: "Good" };
                if (total >= 40) return { g: "P", c: "Pass" };
                return { g: "F", c: "Fail" };
              };

              // Class averages (optional - include if you already added it)
              const classAverages =
                (await GoogleSheetService.getClassAverages(cls, "midterm")) ||
                {};

              // Build one report card
              let reportHTML = `
        <div class="student-report">
          <!-- Header -->
          <div class="rp-header" style="display: flex; align-items: center; justify-content: center; margin-bottom: 12px; gap: 20px;">
            <img src="https://z-cdn-media.chatglm.cn/files/cc741a52-6dc8-4d89-97cb-fdf1a87aa38a.png?auth_key=1868210321-d7534ff785814de88115631510ed5dbc-0-0d208a01c26657a242308b62449ab19b" 
                 alt="Logo" style="width: 70px; height: 70px; object-fit: contain;">
            <div style="text-align: left;">
              <h1 style="color: #1e40af; margin: 0; font-size: 1.6rem;">NIFTY STEPS COLLEGE</h1>
              <p style="font-size: 0.85rem; margin: 4px 0 0;">31 Yinka Ogunfile Street, Igbo Oluwo Estate, Ikorodu, Lagos State</p>
              <p style="font-size: 0.8rem; margin: 2px 0;">www.niftysteps.com.ng | admin@niftysteps.com.ng</p>
              <h3 style="margin: 12px 0 0; text-decoration: underline; text-transform: uppercase; font-size: 0.95rem;">
                ${isJSS ? "Junior" : "Senior"} Secondary School ${term} MID-TERM REPORT SHEET
              </h3>
            </div>
          </div>

          <!-- Student Info -->
          <div style="display: flex; justify-content: space-between; border: 1px solid #000; padding: 8px; margin-bottom: 16px;">
            <div>
              <strong>NAME:</strong> ${s.name.toUpperCase()}<br>
              <strong>CLASS:</strong> ${s.class} ${s.dept ? `(${s.dept})` : ""}
            </div>
            <div style="text-align: right;">
              <strong>ADMIN NO:</strong> ${s.id}<br>
              <strong>SESSION:</strong> ${session}
            </div>
          </div>

          <!-- Table -->
          <table class="rp-table" style="width:100%; border-collapse: collapse; border: 1px solid #000; font-size: 0.80rem;">
            <thead>
              <tr style="background: #e2e8f0;">
                <th style="border:1px solid #000; padding:5px; text-align:left;">SUBJECTS</th>
                <th style="border:1px solid #000; padding:5px;">MARK OBTAINABLE</th>
                <th style="border:1px solid #000; padding:5px;">MARK OBTAINED</th>
                <th style="border:1px solid #000; padding:5px;">CLASS AVG</th>
                <th style="border:1px solid #000; padding:5px;">GRADE</th>
                <th style="border:1px solid #000; padding:5px; text-align:left;">COMMENT</th>
              </tr>
            </thead>
            <tbody>
              ${subjectsList
                .map((sub) => {
                  const sc = s.scores[sub] || { total: "" };
                  const total = Number(sc.total) || 0;
                  const gradeInfo = getMidTermGradeInfo(total);
                  const show = total > 0;
                  const avg = classAverages[sub]
                    ? Math.round(classAverages[sub])
                    : "-";
                  return `
                  <tr>
                    <td style="border:1px solid #000; padding:5px;">${sub}</td>
                    <td style="border:1px solid #000; text-align:center;">100</td>
                    <td style="border:1px solid #000; text-align:center;">${show ? total : "-"}</td>
                    <td style="border:1px solid #000; text-align:center;">${avg}</td>
                    <td style="border:1px solid #000; text-align:center; font-weight:bold;">${show ? gradeInfo.g : "-"}</td>
                    <td style="border:1px solid #000; padding:5px;">${show ? gradeInfo.c : "-"}</td>
                  </tr>`;
                })
                .join("")}
              <tr style="background:#f1f5f9; font-weight:bold;">
                <td colspan="2" style="border:1px solid #000; padding:5px;">TOTAL:</td>
                <td style="border:1px solid #000; text-align:center;">${grandTotalScore}</td>
                <td style="border:1px solid #000; text-align:center;">-</td>
                <td colspan="2" style="border:1px solid #000; text-align:center;">PERCENTAGE: ${overallPercentage}%</td>
              </tr>
            </tbody>
          </table>


          <!-- GRADING & COMMENT SYSTEMS -->
        <div style="display: flex; justify-content: space-between; gap: 20px; margin-bottom: 20px;">
          <div style="width: 48%;">
            <strong>Grading System</strong>
            <table style="width: 100%; border-collapse: collapse; border: 1px solid #000; font-size: 0.8rem;">
              <tr><td style="border: 1px solid #000; padding: 4px;">80 - 100%</td><td style="border: 1px solid #000; padding: 4px;">A</td><td style="border: 1px solid #000; padding: 4px;">70 - 79%</td><td style="border: 1px solid #000; padding: 4px;">B</td></tr>
              <tr><td style="border: 1px solid #000; padding: 4px;">60 - 69%</td><td style="border: 1px solid #000; padding: 4px;">BC</td><td style="border: 1px solid #000; padding: 4px;">50 - 59%</td><td style="border: 1px solid #000; padding: 4px;">C</td></tr>
              <tr><td style="border: 1px solid #000; padding: 4px;">40 - 49%</td><td style="border: 1px solid #000; padding: 4px;">P</td><td style="border: 1px solid #000; padding: 4px;">0 - 39%</td><td style="border: 1px solid #000; padding: 4px;">F</td></tr>
            </table>
          </div>
          <div style="width: 48%;">
            <strong>Comment System</strong>
            <table style="width: 100%; border-collapse: collapse; border: 1px solid #000; font-size: 0.8rem;">
              <tr><td style="border: 1px solid #000; padding: 4px;">A</td><td style="border: 1px solid #000; padding: 4px;">Distinction</td><td style="border: 1px solid #000; padding: 4px;">B</td><td style="border: 1px solid #000; padding: 4px;">Excellent</td></tr>
              <tr><td style="border: 1px solid #000; padding: 4px;">BC</td><td style="border: 1px solid #000; padding: 4px;">Very Good</td><td style="border: 1px solid #000; padding: 4px;">C</td><td style="border: 1px solid #000; padding: 4px;">Good</td></tr>
              <tr><td style="border: 1px solid #000; padding: 4px;">P</td><td style="border: 1px solid #000; padding: 4px;">Pass</td><td style="border: 1px solid #000; padding: 4px;">F</td><td style="border: 1px solid #000; padding: 4px;">Fail</td></tr>
            </table>
          </div>
        </div>

          <!-- Comments -->
          <div style="margin-top:20px; display:flex; justify-content:space-between; gap:20px;">
            <div style="width:60%; border:1px solid #000; padding:10px; font-size:0.85rem;">
              <strong>TEACHER'S COMMENT:</strong><br>
              ${s.name.split(" ")[0]} ${randomTeacherComment}
            </div>
            <div style="width:38%; border:1px solid #000; padding:10px; font-size:0.85rem;">
              <strong>PRINCIPAL'S COMMENT:</strong><br>
              ${principalComment}
            </div>
          </div>

          <!-- Signature -->
          <div style="margin-top:30px; text-align:right;">
            <div style="border-bottom:1px solid #000; width:170px; height:50px; margin-left:auto;"></div>
            <p style="font-size:0.8rem; margin-top:5px;">Principal's Signature</p>
          </div>
        </div>
      `;

              printable.innerHTML += reportHTML;
            }

            // Trigger browser print
            setTimeout(() => {
              window.print();
              // Restore original print button behavior
              originalPrintBtn.onclick = originalOnClick;
            }, 800);
          };
        },
      };

      document.addEventListener("DOMContentLoaded", () => app.init());
    </script>
  </body>
</html>
